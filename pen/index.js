!function(e){const t=e.ArgumentType,r=e.BlockType,a=e.TargetType,n=e.Cast,o=e.Clone,i=e.Color,s=e.formatMessage,l=e.MathUtil,p=e.log,c="TARGET_MOVED",u={COLOR:"color",SATURATION:"saturation",BRIGHTNESS:"brightness",TRANSPARENCY:"transparency"};e.extensions.register(new class M{constructor(){this.runtime=e.vm.runtime,this._penDrawableId=-1,this._penSkinId=-1,this._onTargetCreated=this._onTargetCreated.bind(this),this._onTargetMoved=this._onTargetMoved.bind(this),this.runtime.on("targetWasCreated",this._onTargetCreated),this.runtime.on("RUNTIME_DISPOSED",this.clear.bind(this))}static get DEFAULT_PEN_STATE(){return{penDown:!1,color:66.66,saturation:100,brightness:100,transparency:0,_shade:50,penAttributes:{color4f:[0,0,1,1],diameter:1}}}static get PEN_SIZE_RANGE(){return{min:1,max:1200}}static get STATE_KEY(){return"Scratch.pen"}_clampPenSize(e){return l.clamp(e,M.PEN_SIZE_RANGE.min,M.PEN_SIZE_RANGE.max)}_getPenLayerID(){return this._penSkinId<0&&this.runtime.renderer&&(this._penSkinId=this.runtime.renderer.createPenSkin(),this._penDrawableId=this.runtime.renderer.createDrawable("pen"),this.runtime.renderer.updateDrawableSkinId(this._penDrawableId,this._penSkinId)),this._penSkinId}_getPenState(e){let t=e.getCustomState(M.STATE_KEY);return t||(t=o.simple(M.DEFAULT_PEN_STATE),e.setCustomState(M.STATE_KEY,t)),t}_onTargetCreated(e,t){(t=t&&t.getCustomState(M.STATE_KEY))&&(e.setCustomState(M.STATE_KEY,o.simple(t)),t.penDown)&&e.addListener(c,this._onTargetMoved)}_onTargetMoved(e,t,r,a){var n;a||0<=(a=this._getPenLayerID())&&(n=this._getPenState(e),this.runtime.renderer.penLine(a,n.penAttributes,t,r,e.x,e.y),this.runtime.requestRedraw())}_wrapColor(e){return l.wrapClamp(e,0,100)}_initColorParam(){return[{text:s({id:"pen.colorMenu.color",default:"color",description:"label for color element in color picker for pen extension"}),value:u.COLOR},{text:s({id:"pen.colorMenu.saturation",default:"saturation",description:"label for saturation element in color picker for pen extension"}),value:u.SATURATION},{text:s({id:"pen.colorMenu.brightness",default:"brightness",description:"label for brightness element in color picker for pen extension"}),value:u.BRIGHTNESS},{text:s({id:"pen.colorMenu.transparency",default:"transparency",description:"label for transparency element in color picker for pen extension"}),value:u.TRANSPARENCY}]}_clampColorParam(e){return l.clamp(e,0,100)}_alphaToTransparency(e){return 100*(1-e)}_transparencyToAlpha(e){return 1-e/100}getInfo(){return{id:"pen",name:s({id:"pen.categoryName",default:"Pen",description:"Label for the pen extension category"}),blockIconURI:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+cGVuLWljb248L3RpdGxlPjxnIHN0cm9rZT0iIzU3NUU3NSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik04Ljc1MyAzNC42MDJsLTQuMjUgMS43OCAxLjc4My00LjIzN2MxLjIxOC0yLjg5MiAyLjkwNy01LjQyMyA1LjAzLTcuNTM4TDMxLjA2NiA0LjkzYy44NDYtLjg0MiAyLjY1LS40MSA0LjAzMi45NjcgMS4zOCAxLjM3NSAxLjgxNiAzLjE3My45NyA0LjAxNUwxNi4zMTggMjkuNTljLTIuMTIzIDIuMTE2LTQuNjY0IDMuOC03LjU2NSA1LjAxMiIgZmlsbD0iI0ZGRiIvPjxwYXRoIGQ9Ik0yOS40MSA2LjExcy00LjQ1LTIuMzc4LTguMjAyIDUuNzcyYy0xLjczNCAzLjc2Ni00LjM1IDEuNTQ2LTQuMzUgMS41NDYiLz48cGF0aCBkPSJNMzYuNDIgOC44MjVjMCAuNDYzLS4xNC44NzMtLjQzMiAxLjE2NGwtOS4zMzUgOS4zYy4yODItLjI5LjQxLS42NjguNDEtMS4xMiAwLS44NzQtLjUwNy0xLjk2My0xLjQwNi0yLjg2OC0xLjM2Mi0xLjM1OC0zLjE0Ny0xLjgtNC4wMDItLjk5TDMwLjk5IDUuMDFjLjg0NC0uODQgMi42NS0uNDEgNC4wMzUuOTYuODk4LjkwNCAxLjM5NiAxLjk4MiAxLjM5NiAyLjg1NU0xMC41MTUgMzMuNzc0Yy0uNTczLjMwMi0xLjE1Ny41Ny0xLjc2NC44M0w0LjUgMzYuMzgybDEuNzg2LTQuMjM1Yy4yNTgtLjYwNC41My0xLjE4Ni44MzMtMS43NTcuNjkuMTgzIDEuNDQ4LjYyNSAyLjEwOCAxLjI4Mi42Ni42NTggMS4xMDIgMS40MTIgMS4yODcgMi4xMDIiIGZpbGw9IiM0Qzk3RkYiLz48cGF0aCBkPSJNMzYuNDk4IDguNzQ4YzAgLjQ2NC0uMTQuODc0LS40MzMgMS4xNjVsLTE5Ljc0MiAxOS42OGMtMi4xMyAyLjExLTQuNjczIDMuNzkzLTcuNTcyIDUuMDFMNC41IDM2LjM4bC45NzQtMi4zMTYgMS45MjUtLjgwOGMyLjg5OC0xLjIxOCA1LjQ0LTIuOSA3LjU3LTUuMDFsMTkuNzQzLTE5LjY4Yy4yOTItLjI5Mi40MzItLjcwMi40MzItMS4xNjUgMC0uNjQ2LS4yNy0xLjQtLjc4LTIuMTIyLjI1LjE3Mi41LjM3Ny43MzcuNjE0Ljg5OC45MDUgMS4zOTYgMS45ODMgMS4zOTYgMi44NTYiIGZpbGw9IiM1NzVFNzUiIG9wYWNpdHk9Ii4xNSIvPjxwYXRoIGQ9Ik0xOC40NSAxMi44M2MwIC41LS40MDQuOTA1LS45MDQuOTA1cy0uOTA1LS40MDUtLjkwNS0uOTA0YzAtLjUuNDA3LS45MDMuOTA2LS45MDMuNSAwIC45MDQuNDA0LjkwNC45MDR6IiBmaWxsPSIjNTc1RTc1Ii8+PC9nPjwvc3ZnPg==",blocks:[{opcode:"clear",blockType:r.COMMAND,text:s({id:"pen.clear",default:"erase all",description:"erase all pen trails and stamps"})},{opcode:"stamp",blockType:r.COMMAND,text:s({id:"pen.stamp",default:"stamp",description:"render current costume on the background"}),filter:[a.SPRITE]},{opcode:"penDown",blockType:r.COMMAND,text:s({id:"pen.penDown",default:"pen down",description:"start leaving a trail when the sprite moves"}),filter:[a.SPRITE]},{opcode:"penUp",blockType:r.COMMAND,text:s({id:"pen.penUp",default:"pen up",description:"stop leaving a trail behind the sprite"}),filter:[a.SPRITE]},{opcode:"setPenColorToColor",blockType:r.COMMAND,text:s({id:"pen.setColor",default:"set pen color to [COLOR]",description:"set the pen color to a particular (RGB) value"}),arguments:{COLOR:{type:t.COLOR}},filter:[a.SPRITE]},{opcode:"changePenColorParamBy",blockType:r.COMMAND,text:s({id:"pen.changeColorParam",default:"change pen [COLOR_PARAM] by [VALUE]",description:"change the state of a pen color parameter"}),arguments:{COLOR_PARAM:{type:t.STRING,menu:"colorParam",defaultValue:u.COLOR},VALUE:{type:t.NUMBER,defaultValue:10}},filter:[a.SPRITE]},{opcode:"setPenColorParamTo",blockType:r.COMMAND,text:s({id:"pen.setColorParam",default:"set pen [COLOR_PARAM] to [VALUE]",description:"set the state for a pen color parameter e.g. saturation"}),arguments:{COLOR_PARAM:{type:t.STRING,menu:"colorParam",defaultValue:u.COLOR},VALUE:{type:t.NUMBER,defaultValue:50}},filter:[a.SPRITE]},{opcode:"changePenSizeBy",blockType:r.COMMAND,text:s({id:"pen.changeSize",default:"change pen size by [SIZE]",description:"change the diameter of the trail left by a sprite"}),arguments:{SIZE:{type:t.NUMBER,defaultValue:1}},filter:[a.SPRITE]},{opcode:"setPenSizeTo",blockType:r.COMMAND,text:s({id:"pen.setSize",default:"set pen size to [SIZE]",description:"set the diameter of a trail left by a sprite"}),arguments:{SIZE:{type:t.NUMBER,defaultValue:1}},filter:[a.SPRITE]},{opcode:"setPenShadeToNumber",blockType:r.COMMAND,text:s({id:"pen.setShade",default:"set pen shade to [SHADE]",description:"legacy pen blocks - set pen shade"}),arguments:{SHADE:{type:t.NUMBER,defaultValue:1}},hideFromPalette:!0},{opcode:"changePenShadeBy",blockType:r.COMMAND,text:s({id:"pen.changeShade",default:"change pen shade by [SHADE]",description:"legacy pen blocks - change pen shade"}),arguments:{SHADE:{type:t.NUMBER,defaultValue:1}},hideFromPalette:!0},{opcode:"setPenHueToNumber",blockType:r.COMMAND,text:s({id:"pen.setHue",default:"set pen color to [HUE]",description:"legacy pen blocks - set pen color to number"}),arguments:{HUE:{type:t.NUMBER,defaultValue:1}},hideFromPalette:!0},{opcode:"changePenHueBy",blockType:r.COMMAND,text:s({id:"pen.changeHue",default:"change pen color by [HUE]",description:"legacy pen blocks - change pen color"}),arguments:{HUE:{type:t.NUMBER,defaultValue:1}},hideFromPalette:!0}],menus:{colorParam:{acceptReporters:!0,items:this._initColorParam()}}}}clear(){var e=this._getPenLayerID();0<=e&&(this.runtime.renderer.penClear(e),this.runtime.requestRedraw())}stamp(e,t){var r=this._getPenLayerID();0<=r&&(t=t.target,this.runtime.renderer.penStamp(r,t.drawableID),this.runtime.requestRedraw())}penDown(e,t){var t=t.target,r=this._getPenState(t),a=(r.penDown||(r.penDown=!0,t.addListener(c,this._onTargetMoved)),this._getPenLayerID());0<=a&&(this.runtime.renderer.penPoint(a,r.penAttributes,t.x,t.y),this.runtime.requestRedraw())}penUp(e,t){var t=t.target,r=this._getPenState(t);r.penDown&&(r.penDown=!1,t.removeListener(c,this._onTargetMoved))}setPenColorToColor(e,t){var t=this._getPenState(t.target),e=n.toRgbColorObject(e.COLOR),r=i.rgbToHsv(e);t.color=r.h/360*100,t.saturation=100*r.s,t.brightness=100*r.v,e.hasOwnProperty("a")?t.transparency=100*(1-e.a/255):t.transparency=0,t._shade=t.brightness/2,this._updatePenColor(t)}_updatePenColor(e){var t=i.hsvToRgb({h:360*e.color/100,s:e.saturation/100,v:e.brightness/100});e.penAttributes.color4f[0]=t.r/255,e.penAttributes.color4f[1]=t.g/255,e.penAttributes.color4f[2]=t.b/255,e.penAttributes.color4f[3]=this._transparencyToAlpha(e.transparency)}_setOrChangeColorParam(e,t,r,a){switch(e){case u.COLOR:r.color=this._wrapColor(t+(a?r.color:0));break;case u.SATURATION:r.saturation=this._clampColorParam(t+(a?r.saturation:0));break;case u.BRIGHTNESS:r.brightness=this._clampColorParam(t+(a?r.brightness:0));break;case u.TRANSPARENCY:r.transparency=this._clampColorParam(t+(a?r.transparency:0));break;default:p.warn("Tried to set or change unknown color parameter: "+e)}this._updatePenColor(r)}changePenColorParamBy(e,t){t=this._getPenState(t.target),this._setOrChangeColorParam(e.COLOR_PARAM,n.toNumber(e.VALUE),t,!0)}setPenColorParamTo(e,t){t=this._getPenState(t.target),this._setOrChangeColorParam(e.COLOR_PARAM,n.toNumber(e.VALUE),t,!1)}changePenSizeBy(e,t){(t=this._getPenState(t.target).penAttributes).diameter=this._clampPenSize(t.diameter+n.toNumber(e.SIZE))}setPenSizeTo(e,t){this._getPenState(t.target).penAttributes.diameter=this._clampPenSize(n.toNumber(e.SIZE))}setPenHueToNumber(e,t){t=this._getPenState(t.target),e=n.toNumber(e.HUE)/2,this._setOrChangeColorParam(u.COLOR,e,t,!1),this._setOrChangeColorParam(u.TRANSPARENCY,0,t,!1),this._legacyUpdatePenColor(t)}changePenHueBy(e,t){t=this._getPenState(t.target),e=n.toNumber(e.HUE)/2,this._setOrChangeColorParam(u.COLOR,e,t,!0),this._legacyUpdatePenColor(t)}setPenShadeToNumber(e,t){t=this._getPenState(t.target);let r=n.toNumber(e.SHADE);(r%=200)<0&&(r+=200),t._shade=r,this._legacyUpdatePenColor(t)}changePenShadeBy(e,t){var r=this._getPenState(t.target),e=n.toNumber(e.SHADE);this.setPenShadeToNumber({SHADE:r._shade+e},t)}_legacyUpdatePenColor(e){let t=i.hsvToRgb({h:360*e.color/100,s:1,v:1});var r=100<e._shade?200-e._shade:e._shade,r=(t=r<50?i.mixRgb(i.RGB_BLACK,t,(10+r)/60):i.mixRgb(t,i.RGB_WHITE,(r-50)/60),i.rgbToHsv(t));e.color=100*r.h/360,e.saturation=100*r.s,e.brightness=100*r.v,this._updatePenColor(e)}})}(Scratch);