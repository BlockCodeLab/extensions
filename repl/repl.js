!function(){const e=Scratch.Serial;Scratch.log;Scratch.export(class{constructor(e,s){this._serial=null,this._runtime=e,this._extensionId=s,this._decoder=new TextDecoder,this._messages="",this._busy=!1,this._waitingFor={},this._listening={},this.reset=this.reset.bind(this),this._onConnect=this._onConnect.bind(this),this._onMessage=this._onMessage.bind(this)}get filters(){throw new Error("must override")}scan(){this._serial&&this._serial.disconnect(),this._serial=new e(this._runtime,this._extensionId,{filters:this.filters},this._onConnect,this.reset)}connect(e){this._serial&&this._serial.connectPeripheral(e)}disconnect(){this._serial&&this._serial.disconnect(),this.reset()}reset(){this._serial=null,this._messages="",this._busy=!1,this._waitingFor={},this._listening={}}isConnected(){let e=!1;return e=this._serial?this._serial.isConnected():e}_onConnect(){this._serial.ondata=this._onMessage}_onMessage(e){this._messages+=this._decoder.decode(e),this._receiveWaiting(),this._receiveListening()}_receiveWaiting(){Object.entries(this._waitingFor).forEach(([e,s])=>{let i=s.waitFor;var t;i instanceof RegExp?(t=(i=i.multiline?i:new RegExp(s.waitFor,"m"+s.waitFor.flags)).exec(this._messages))&&(s.resolve(t),this._messages=this._messages.replace(i,""),this._removeWaiting(e)):this._messages.includes(i)?(s.resolve(),this._messages=this._messages.replace(i,""),this._removeWaiting(e)):/Error:/.test(i)&&s.reject()})}async write(e,s,i){return!this._busy&&this.isConnected()&&(this._busy=!0,"string"==typeof e?await this._serial.write(e,"text"):await this._serial.write(e,"binary"),this._busy=!1,s)?this._promisesTo(s,i):void 0}async transfer(e){this._busy||this.isConnected()&&(this._busy=!0,await this._serial.transfer("code",e),this._busy=!1)}_promisesTo(t,n=6e4){return new Promise((e,s)=>{const i=setTimeout(()=>this._waitingTimeout(i),n);this._waitingFor[i]={waitFor:t,resolve:e,reject:s}})}_waitingTimeout(e){var s=this._waitingFor[e];s&&s.reject(new Error(`wait for '${s.waitFor}' timeout`)),this._removeWaiting(e)}_removeWaiting(e){clearTimeout(e),this._waitingFor[e]=null,delete this._waitingFor[e]}on(e,s){var i=""+e;e.multiline||(e=new RegExp(e,"m"+e.flags)),this._listening[i]=[e,s]}off(e){delete this._listening[""+e]}_receiveListening(){Object.values(this._listening).forEach(([e,s])=>{var i=e.exec(this._messages);i&&(s(i),this._messages=this._messages.replace(e,""))})}})}();