(async function(i,t){const s=await t("./library.js");t=await t("./translations.json");const e=i.ArgumentType,a=i.BlockType,f=i.Cast,l=i.formatMessage,A=i.Base64Util;i.log;const R=e=>new Promise(t=>setTimeout(t,e)),g=(t,e,a)=>(248&t)<<8|(252&e)<<3|a>>3;var o="[0m\r7> ";const N=`\r
[90mundefined[0m\r
`+o;const r=["rpipico","picoed2"],u=[135,240,320],n=[135,240],d={ON:"on",OFF:"off"},p={UP:"0",RIGHT:"1",DOWN:"2",LEFT:"3"},c={DIRECT:"direct",BUFFER:"buffer"},h={NONE:"0",SIDE_TO_SIDE:"1",TURN_UPSIDE_DOWN:"2",ROTATE_180:"3"};i.extensions.register(new(class y{static get EXTENSION_ID(){return"st7789Display"}constructor(){this.runtime=i.vm.runtime,this.reset(),this.reset=this.reset.bind(this),this.initialBoard=this.initialBoard.bind(this),this.removeBoard=this.removeBoard.bind(this),this.runtime.on("PROJECT_STOP_ALL",this.reset),this.runtime.on("PERIPHERAL_DISCONNECTED",this.reset),this.runtime.on("SELECT_BOARD",this.initialBoard),this.runtime.on("REMOVE_BOARD",this.removeBoard)}async initialBoard(t,e){if(t===y.EXTENSION_ID){const a=await i.extensions.getService(e);a("put",Object.entries(s)),this.gpio=await a("pinsMap"),this.run=t=>a("run",t),this.send=(t,e)=>a("send",t,e)}}removeBoard(){this.gpio=null,this.run=null,this.send=null,this.reset()}reset(){this.st7789=null,this.option={width:240,height:240,baudrate:40,rotation:0,displayMode:c.DIRECT},this.imageCache=null}get DISPLAY_MODE_MENU(){return[{text:l({id:"st7789Display.direct",default:"direct"}),value:c.DIRECT},{text:l({id:"st7789Display.buffer",default:"buffer"}),value:c.BUFFER}]}get WIDTH_MENU(){return u.map(t=>({text:""+t,value:t}))}get HEIGHT_MENU(){return n.map(t=>({text:""+t,value:t}))}get DISPLAY_ROTATION_MENU(){return[{text:l({id:"st7789Display.rotationUp",default:"up"}),value:p.UP},{text:l({id:"st7789Display.rotationLeft",default:"left"}),value:p.LEFT},{text:l({id:"st7789Display.rotationDown",default:"down"}),value:p.DOWN},{text:l({id:"st7789Display.rotationRight",default:"right"}),value:p.RIGHT}]}get BACKLIGHT_STATE_MENU(){return[{text:l({id:"st7789Display.on",default:"on"}),value:d.ON},{text:l({id:"st7789Display.off",default:"off"}),value:d.OFF}]}get FLIP_MENU(){return[{text:l({id:"st7789Display.none",default:"none"}),value:h.NONE},{text:l({id:"st7789Display.flip.side",default:"side to side"}),value:h.SIDE_TO_SIDE},{text:l({id:"st7789Display.flip.updown",default:"turn upside down"}),value:h.TURN_UPSIDE_DOWN},{text:l({id:"st7789Display.flip.rotate",default:"rotate 180"}),value:h.ROTATE_180}]}LISTS_MENU(){var t=this.runtime.getTargetForStage(),e=this.runtime.getEditingTarget(),t=Object.values(t.variables).filter(this._filter),e=Object.values(e.variables).filter(this._filter);return 0<(t=[...new Set([...t,...e])]).length?t.map(t=>({text:t.name,value:t.id})):[l({id:"st7789Display.none",default:"none"})]}_filter(t){if("list"!==t.type||!Array.isArray(t.value))return!1;if(0===t.value.length)return!0;const e=encodeURIComponent("data:image/png;base64");return t.value.every(t=>1<(t=(""+t).split(",")).length&&t[1]&&t[1].includes(e))}getInfo(){return{id:y.EXTENSION_ID,name:l({id:"st7789Display.name",default:"ST7789 Display"}),boards:r,blockIconURI:"data:image/png;base64,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",blocks:[{opcode:"initialGallery",blockType:a.COMMAND,text:l({id:"st7789Display.initialGallery",default:"initial pixel gallery [GALLERY]"}),arguments:{GALLERY:{type:e.STRING,menu:"LISTS"},COLOR:{type:e.COLOR,defaultValue:"#000000"}}},"---",{opcode:"setSPI",blockType:a.COMMAND,text:l({id:"st7789Display.setSPI",default:"set SPI bus [BUS] baudrate [BAUDRATE] and SCK [SCK] MOSI [MOSI]"}),arguments:{BUS:{type:e.NUMBER,defaultValue:0},BAUDRATE:{type:e.NUMBER,defaultValue:this.option.baudrate},SCK:{type:e.NUMBER,defaultValue:-1},MOSI:{type:e.NUMBER,defaultValue:-1}}},{opcode:"setPins",blockType:a.COMMAND,text:l({id:"st7789Display.setPins",default:"set control pins DC [DC] CS [CS] reset [RST] and backlight [BL]"}),arguments:{DC:{type:e.NUMBER,defaultValue:-1},CS:{type:e.NUMBER,defaultValue:-1},RST:{type:e.NUMBER,defaultValue:-1},BL:{type:e.NUMBER,defaultValue:-1}}},{opcode:"setResolution",blockType:a.COMMAND,text:l({id:"st7789Display.setResolution",default:"set display width [WIDTH] and height [HEIGHT]"}),arguments:{WIDTH:{type:e.NUMBER,menu:"width",defaultValue:240},HEIGHT:{type:e.NUMBER,menu:"height",defaultValue:240}}},{opcode:"setMode",blockType:a.COMMAND,text:l({id:"st7789Display.setMode",default:"set display mode [MODE]"}),arguments:{MODE:{type:e.STRING,menu:"displayMode",defaultValue:c.BUFFER}}},{opcode:"setRotation",blockType:a.COMMAND,text:l({id:"st7789Display.setRotation",default:"set display rotation [ROTATION]"}),arguments:{ROTATION:{type:e.STRING,menu:"displayRotation",defaultValue:p.UP}}},{opcode:"setBacklight",blockType:a.COMMAND,text:l({id:"st7789Display.setBacklight",default:"set display backlight [STATE]"}),arguments:{STATE:{type:e.STRING,menu:"backlightState",defaultValue:d.OFF}}},{opcode:"getWidth",blockType:a.REPORTER,text:l({id:"st7789Display.getWidth",defalut:"display width"})},{opcode:"getHeight",blockType:a.REPORTER,text:l({id:"st7789Display.getHeight",defalut:"display height"})},"---",{opcode:"fillScreen",blockType:a.COMMAND,text:l({id:"st7789Display.fillScreen",default:"set screen color to [COLOR]"}),arguments:{COLOR:{type:e.COLOR}}},{opcode:"drawImage",blockType:a.COMMAND,text:l({id:"st7789Display.drawImage",default:"draw image [IMAGE] at x: [X] y: [Y] size to [SIZE] and flip [FLIP]"}),arguments:{IMAGE:{type:e.STRING,defaultValue:"png;base64"},X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},SIZE:{type:e.NUMBER,defaultValue:100},FLIP:{type:e.NUMBER,menu:"flip",defaultValue:h.NONE}}},{opcode:"displayBuffer",blockType:a.COMMAND,text:l({id:"st7789Display.displayBuffer",default:"display buffer"})},{opcode:"clearScreen",blockType:a.COMMAND,text:l({id:"st7789Display.clearScreen",default:"clear screen"})},"---",{opcode:"setPenColor",blockType:a.COMMAND,text:l({id:"st7789Display.setColor",default:"set pen color to [COLOR]"}),arguments:{COLOR:{type:e.COLOR}}},{opcode:"setFillColor",blockType:a.COMMAND,text:l({id:"st7789Display.setFillColor",default:"set fill color to [COLOR]"}),arguments:{COLOR:{type:e.COLOR}}},"---",{opcode:"setPixel",blockType:a.COMMAND,text:l({id:"st7789Display.setPixel",default:"set pixel x: [X] y: [Y] color to [COLOR]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},COLOR:{type:e.COLOR}}},{opcode:"drawLine",blockType:a.COMMAND,text:l({id:"st7789Display.drawLine",default:"draw line from x1: [X1] y1: [Y1] to x2: [X2] y2: [Y2]"}),arguments:{X1:{type:e.NUMBER,defaultValue:0},Y1:{type:e.NUMBER,defaultValue:0},X2:{type:e.NUMBER,defaultValue:100},Y2:{type:e.NUMBER,defaultValue:100}}},{opcode:"drawRect",blockType:a.COMMAND,text:l({id:"st7789Display.drawRect",default:"draw rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},WIDTH:{type:e.NUMBER,defaultValue:100},HEIGHT:{type:e.NUMBER,defaultValue:50}}},{opcode:"fillRect",blockType:a.COMMAND,text:l({id:"st7789Display.fillRect",default:"fill rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},WIDTH:{type:e.NUMBER,defaultValue:100},HEIGHT:{type:e.NUMBER,defaultValue:50}}},{opcode:"drawCircle",blockType:a.COMMAND,text:l({id:"st7789Display.drawCircle",default:"draw circle at x: [X] y: [Y] of radius: [R]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},R:{type:e.NUMBER,defaultValue:50}}},{opcode:"fillCircle",blockType:a.COMMAND,text:l({id:"st7789Display.fillCircle",default:"fill circle at x: [X] y: [Y] of radius: [R]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},R:{type:e.NUMBER,defaultValue:50}}},{opcode:"drawRoundRect",blockType:a.COMMAND,text:l({id:"st7789Display.drawRoundRect",default:"draw round rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT] and radius: [R]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},WIDTH:{type:e.NUMBER,defaultValue:100},HEIGHT:{type:e.NUMBER,defaultValue:50},R:{type:e.NUMBER,defaultValue:5}}},{opcode:"fillRoundRect",blockType:a.COMMAND,text:l({id:"st7789Display.fillRoundRect",default:"fill round rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT] and radius: [R]"}),arguments:{X:{type:e.NUMBER,defaultValue:0},Y:{type:e.NUMBER,defaultValue:0},WIDTH:{type:e.NUMBER,defaultValue:100},HEIGHT:{type:e.NUMBER,defaultValue:50},R:{type:e.NUMBER,defaultValue:5}}}],menus:{LISTS:{items:"LISTS_MENU"},width:{acceptReporters:!1,items:this.WIDTH_MENU},height:{acceptReporters:!1,items:this.HEIGHT_MENU},backlightState:{acceptReporters:!1,items:this.BACKLIGHT_STATE_MENU},displayRotation:{acceptReporters:!1,items:this.DISPLAY_ROTATION_MENU},displayMode:{acceptReporters:!1,items:this.DISPLAY_MODE_MENU},flip:{acceptReporters:!1,items:this.FLIP_MENU}}}}async getDevice(){if(this.send){const{width:a,height:i,baudrate:s,bus:l,sck:o,mosi:r,dc:u,cs:n,rst:d,bl:p}=this.option;if(-1!==o&&-1!==r&&-1!==u&&-1!==n&&-1!==d){const c=`display_${l}_${o}_`+r;if(this.st7789){if(this.st7789.name===c)return this.st7789;this.st7789=null}else await this.send("const ST7789 = (function (f){return eval(new TextDecoder().decode(require('fs').readFile(f)))})('./st7789.js')",N);await this.send(`const ${c} = new ST7789()`,N);var t=JSON.stringify({baudrate:1e6*s,miso:-1,sck:o,mosi:r}),e=JSON.stringify({rotation:0,width:a,height:i,dc:u,cs:n,rst:d,bl:p});await this.send(c+`.setup(board.spi(${l}, ${t}), ${e})`,N),R(100);const h=this.send.bind(this),y=this.option;return this.st7789={get name(){return c},get gc(){return`${this.name}.getContext('${y.displayMode}')`},on(){if(-1!==p)return h(this.name+".on()",N)},off(){if(-1!==p)return h(this.name+".off()",N)},send(t){return h(this.gc+"."+t,N)},color16(t,e,a){return this.gc+`.color16(${t},${e},${a})`}},await this.st7789.send("clearScreen()"),await this.st7789.on(),this.st7789}}}setSPI(t){this.gpio&&(this.option.bus=f.toNumber(t.BUS),this.option.baudrate=f.toNumber(t.BAUDRATE),this.option.sck=f.toNumber(this.gpio[t.SCK]),this.option.mosi=f.toNumber(this.gpio[t.MOSI]))}setPins(t){this.gpio&&(this.option.dc=f.toNumber(this.gpio[t.DC]),this.option.cs=f.toNumber(this.gpio[t.CS]),this.option.rst=f.toNumber(this.gpio[t.RST]),this.option.bl=f.toNumber(this.gpio[t.BL]))}setResolution(t){this.option.width=f.toNumber(t.WIDTH),this.option.height=f.toNumber(t.HEIGHT)}async setRotation(t){this.option.rotation=f.toNumber(t.ROTATION),(t=await this.getDevice())&&await t.send(`setRotation(${this.option.rotation})`)}async setBacklight(t){var e=await this.getDevice();e&&await e[f.toString(t.STATE)]()}getWidth(){return this.option.width}getHeight(){return this.option.height}setMode(t){this.option.displayMode=f.toString(t.MODE)}async displayBuffer(){var t;this.option.displayMode===c.BUFFER&&(t=await this.getDevice())&&await t.send("display()")}async clearScreen(t){var e=await this.getDevice();e&&await e.send("clearScreen()")}async fillScreen(t){var e,a,i=await this.getDevice();i&&({r:t,g:e,b:a}=f.toRgbColorObject(t.COLOR),t=i.color16(t,e,a),await i.send(`fillScreen(${t})`))}async setPixel(t){var e,a,i,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),{r:t,g:i,b:s}=f.toRgbColorObject(t.COLOR),t=l.color16(t,i,s),await l.send(`setPixel(${e},${a},${t})`))}async setPenColor(t){var e,a,i=await this.getDevice();i&&({r:t,g:e,b:a}=f.toRgbColorObject(t.COLOR),t=i.color16(t,e,a),await i.send(`setColor(${t})`))}async setFillColor(t){var e,a,i=await this.getDevice();i&&({r:t,g:e,b:a}=f.toRgbColorObject(t.COLOR),t=i.color16(t,e,a),await i.send(`setFillColor(${t})`))}async drawLine(t){var e,a,i,s=await this.getDevice();s&&(e=f.toNumber(t.X1),a=f.toNumber(t.Y1),i=f.toNumber(t.X2),t=f.toNumber(t.Y2),await s.send(`drawLine(${e},${a},${i},${t})`))}async drawRect(t){var e,a,i,s=await this.getDevice();s&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),i=f.toNumber(t.WIDTH),t=f.toNumber(t.HEIGHT),await s.send(`drawRect(${e},${a},${i},${t})`))}async fillRect(t){var e,a,i,s=await this.getDevice();s&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),i=f.toNumber(t.WIDTH),t=f.toNumber(t.HEIGHT),await s.send(`fillRect(${e},${a},${i},${t})`))}async drawCircle(t){var e,a,i=await this.getDevice();i&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),t=f.toNumber(t.R),await i.send(`drawCircle(${e},${a},${t})`))}async fillCircle(t){var e,a,i=await this.getDevice();i&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),t=f.toNumber(t.R),await i.send(`fillCircle(${e},${a},${t})`))}async drawRoundRect(t){var e,a,i,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),i=f.toNumber(t.WIDTH),s=f.toNumber(t.HEIGHT),t=f.toNumber(t.R),await l.send(`drawRoundRect(${e},${a},${i},${s},${t})`))}async fillRoundRect(t){var e,a,i,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),i=f.toNumber(t.WIDTH),s=f.toNumber(t.HEIGHT),t=f.toNumber(t.R),await l.send(`fillRoundRect(${e},${a},${i},${s},${t})`))}async initialGallery(c,t){var e=f.toString(c.GALLERY),t=t.target.lookupVariableById(e);const h=[],y=new Map;e=t.value.map(t=>{var[,t]=t.split(",");const p=decodeURIComponent(t);return new Promise(n=>{const d=new Image;d.src=p,d.onload=()=>{var a=new Uint16Array(d.width*d.height),t={width:d.width,height:d.height,bpp:16},e={color:65535},i=(c.COLOR&&(e.transparent=g(...f.toRgbColorList(c.COLOR)),a.fill(e.transparent)),document.createElement("canvas")),s=(i.width=d.width,i.height=d.height,i.getContext("2d"));s.drawImage(d,0,0,d.width,d.width);for(let e=0;e<d.width;e++)for(let t=0;t<d.height;t++){var[l,o,r,u]=s.getImageData(e,t,1,1).data;0!==u&&(a[t*d.width+e]=g(l,o,r))}t.data=A.arrayBufferToBase64(a.buffer),i="bitmap_"+Date.now().toString(36),h.push(`const ${i}=${JSON.stringify({bitmap:t,option:e})};`),y.set(p,i),n()}})}),await Promise.all(e),await this.run(h.join("\n")),this.imageCache=y}async drawImage(t){var e,a,i,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),a=f.toNumber(t.Y),i=f.toString(t.IMAGE),t={scaleX:s=f.toNumber(t.SIZE)/100,scaleY:s,flipX:!!((s=f.toNumber(t.FLIP))&h.TURN_UPSIDE_DOWN),flipY:!!(s&h.SIDE_TO_SIDE)},this.imageCache)&&this.imageCache.has(i)&&(s=this.imageCache.get(i),await l.send(`drawBitmap(${e},${a},${s}.bitmap,Object.assign(${s}.option, ${JSON.stringify(t)}))`))}})),i.extensions.translations(t),await i.extensions.use("pixelGallery"),i.vm.emit("EXTENSION_SELECTED")})(Scratch,require,exports);