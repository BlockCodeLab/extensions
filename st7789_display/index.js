!async function(a){const t=a.ArgumentType,e=a.BlockType,f=a.Cast,i=a.formatMessage,A=a.Base64Util;a.log;const s=await a.require("./library.js");var l=await a.require("./translations.js");a.extensions.translations(l);const R=e=>new Promise(t=>setTimeout(t,e)),g=(t,e,i)=>(248&t)<<8|(252&e)<<3|i>>3;l="[0m\r7> ";const N=`\r
[90mundefined[0m\r
`+l;const o=["rpipico","picoed2"],r=[135,240,320],u=[135,240],n={ON:"on",OFF:"off"},d={UP:"0",RIGHT:"1",DOWN:"2",LEFT:"3"},p={DIRECT:"direct",BUFFER:"buffer"},c={NONE:"0",SIDE_TO_SIDE:"1",TURN_UPSIDE_DOWN:"2",ROTATE_180:"3"};a.extensions.register(new class h{static get EXTENSION_ID(){return"st7789Display"}constructor(){this.runtime=a.vm.runtime,this.reset(),this.reset=this.reset.bind(this),this.initialBoard=this.initialBoard.bind(this),this.removeBoard=this.removeBoard.bind(this),this.runtime.on("PROJECT_STOP_ALL",this.reset),this.runtime.on("PERIPHERAL_DISCONNECTED",this.reset),this.runtime.on("SELECT_BOARD",this.initialBoard),this.runtime.on("REMOVE_BOARD",this.removeBoard)}async initialBoard(t,e){if(t===h.EXTENSION_ID){const i=await a.extensions.getService(e);i("put",Object.entries(s)),this.gpio=await i("pinsMap"),this.run=t=>i("run",t),this.send=(t,e)=>i("send",t,e)}}removeBoard(){this.gpio=null,this.run=null,this.send=null,this.reset()}reset(){this.st7789=null,this.option={width:240,height:240,baudrate:40,rotation:0,displayMode:p.DIRECT},this.imageCache=null}get DISPLAY_MODE_MENU(){return[{text:i({id:"st7789Display.direct",default:"direct"}),value:p.DIRECT},{text:i({id:"st7789Display.buffer",default:"buffer"}),value:p.BUFFER}]}get WIDTH_MENU(){return r.map(t=>({text:""+t,value:t}))}get HEIGHT_MENU(){return u.map(t=>({text:""+t,value:t}))}get DISPLAY_ROTATION_MENU(){return[{text:i({id:"st7789Display.rotationUp",default:"up"}),value:d.UP},{text:i({id:"st7789Display.rotationLeft",default:"left"}),value:d.LEFT},{text:i({id:"st7789Display.rotationDown",default:"down"}),value:d.DOWN},{text:i({id:"st7789Display.rotationRight",default:"right"}),value:d.RIGHT}]}get BACKLIGHT_STATE_MENU(){return[{text:i({id:"st7789Display.on",default:"on"}),value:n.ON},{text:i({id:"st7789Display.off",default:"off"}),value:n.OFF}]}get FLIP_MENU(){return[{text:i({id:"st7789Display.none",default:"none"}),value:c.NONE},{text:i({id:"st7789Display.flip.side",default:"side to side"}),value:c.SIDE_TO_SIDE},{text:i({id:"st7789Display.flip.updown",default:"turn upside down"}),value:c.TURN_UPSIDE_DOWN},{text:i({id:"st7789Display.flip.rotate",default:"rotate 180"}),value:c.ROTATE_180}]}LISTS_MENU(){var t=this.runtime.getTargetForStage(),e=this.runtime.getEditingTarget(),t=Object.values(t.variables).filter(this._filter),e=Object.values(e.variables).filter(this._filter);return 0<(t=[...new Set([...t,...e])]).length?t.map(t=>({text:t.name,value:t.id})):[i({id:"st7789Display.none",default:"none"})]}_filter(t){if("list"!==t.type||!Array.isArray(t.value))return!1;if(0===t.value.length)return!0;const e=encodeURIComponent("data:image/png;base64");return t.value.every(t=>1<(t=(""+t).split(",")).length&&t[1]&&t[1].includes(e))}getInfo(){return{id:h.EXTENSION_ID,name:i({id:"st7789Display.name",default:"ST7789 Display"}),boards:o,blockIconURI:"data:image/png;base64,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",blocks:[{opcode:"initialGallery",blockType:e.COMMAND,text:i({id:"st7789Display.initialGallery",default:"initial pixel gallery [GALLERY]"}),arguments:{GALLERY:{type:t.STRING,menu:"LISTS"},COLOR:{type:t.COLOR,defaultValue:"#000000"}}},"---",{opcode:"setSPI",blockType:e.COMMAND,text:i({id:"st7789Display.setSPI",default:"set SPI bus [BUS] baudrate [BAUDRATE] and SCK [SCK] MOSI [MOSI]"}),arguments:{BUS:{type:t.NUMBER,defaultValue:0},BAUDRATE:{type:t.NUMBER,defaultValue:this.option.baudrate},SCK:{type:t.NUMBER,defaultValue:-1},MOSI:{type:t.NUMBER,defaultValue:-1}}},{opcode:"setPins",blockType:e.COMMAND,text:i({id:"st7789Display.setPins",default:"set control pins DC [DC] CS [CS] reset [RST] and backlight [BL]"}),arguments:{DC:{type:t.NUMBER,defaultValue:-1},CS:{type:t.NUMBER,defaultValue:-1},RST:{type:t.NUMBER,defaultValue:-1},BL:{type:t.NUMBER,defaultValue:-1}}},{opcode:"setResolution",blockType:e.COMMAND,text:i({id:"st7789Display.setResolution",default:"set display width [WIDTH] and height [HEIGHT]"}),arguments:{WIDTH:{type:t.NUMBER,menu:"width",defaultValue:240},HEIGHT:{type:t.NUMBER,menu:"height",defaultValue:240}}},{opcode:"setMode",blockType:e.COMMAND,text:i({id:"st7789Display.setMode",default:"set display mode [MODE]"}),arguments:{MODE:{type:t.STRING,menu:"displayMode",defaultValue:p.BUFFER}}},{opcode:"setRotation",blockType:e.COMMAND,text:i({id:"st7789Display.setRotation",default:"set display rotation [ROTATION]"}),arguments:{ROTATION:{type:t.STRING,menu:"displayRotation",defaultValue:d.UP}}},{opcode:"setBacklight",blockType:e.COMMAND,text:i({id:"st7789Display.setBacklight",default:"set display backlight [STATE]"}),arguments:{STATE:{type:t.STRING,menu:"backlightState",defaultValue:n.OFF}}},{opcode:"getWidth",blockType:e.REPORTER,text:i({id:"st7789Display.getWidth",defalut:"display width"})},{opcode:"getHeight",blockType:e.REPORTER,text:i({id:"st7789Display.getHeight",defalut:"display height"})},"---",{opcode:"fillScreen",blockType:e.COMMAND,text:i({id:"st7789Display.fillScreen",default:"set screen color to [COLOR]"}),arguments:{COLOR:{type:t.COLOR}}},{opcode:"drawImage",blockType:e.COMMAND,text:i({id:"st7789Display.drawImage",default:"draw image [IMAGE] at x: [X] y: [Y] size to [SIZE] and flip [FLIP]"}),arguments:{IMAGE:{type:t.STRING,defaultValue:"png;base64"},X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},SIZE:{type:t.NUMBER,defaultValue:100},FLIP:{type:t.NUMBER,menu:"flip",defaultValue:c.NONE}}},{opcode:"displayBuffer",blockType:e.COMMAND,text:i({id:"st7789Display.displayBuffer",default:"display buffer"})},{opcode:"clearScreen",blockType:e.COMMAND,text:i({id:"st7789Display.clearScreen",default:"clear screen"})},"---",{opcode:"setPenColor",blockType:e.COMMAND,text:i({id:"st7789Display.setColor",default:"set pen color to [COLOR]"}),arguments:{COLOR:{type:t.COLOR}}},{opcode:"setFillColor",blockType:e.COMMAND,text:i({id:"st7789Display.setFillColor",default:"set fill color to [COLOR]"}),arguments:{COLOR:{type:t.COLOR}}},"---",{opcode:"setPixel",blockType:e.COMMAND,text:i({id:"st7789Display.setPixel",default:"set pixel x: [X] y: [Y] color to [COLOR]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},COLOR:{type:t.COLOR}}},{opcode:"drawLine",blockType:e.COMMAND,text:i({id:"st7789Display.drawLine",default:"draw line from x1: [X1] y1: [Y1] to x2: [X2] y2: [Y2]"}),arguments:{X1:{type:t.NUMBER,defaultValue:0},Y1:{type:t.NUMBER,defaultValue:0},X2:{type:t.NUMBER,defaultValue:100},Y2:{type:t.NUMBER,defaultValue:100}}},{opcode:"drawRect",blockType:e.COMMAND,text:i({id:"st7789Display.drawRect",default:"draw rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},WIDTH:{type:t.NUMBER,defaultValue:100},HEIGHT:{type:t.NUMBER,defaultValue:50}}},{opcode:"fillRect",blockType:e.COMMAND,text:i({id:"st7789Display.fillRect",default:"fill rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},WIDTH:{type:t.NUMBER,defaultValue:100},HEIGHT:{type:t.NUMBER,defaultValue:50}}},{opcode:"drawCircle",blockType:e.COMMAND,text:i({id:"st7789Display.drawCircle",default:"draw circle at x: [X] y: [Y] of radius: [R]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},R:{type:t.NUMBER,defaultValue:50}}},{opcode:"fillCircle",blockType:e.COMMAND,text:i({id:"st7789Display.fillCircle",default:"fill circle at x: [X] y: [Y] of radius: [R]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},R:{type:t.NUMBER,defaultValue:50}}},{opcode:"drawRoundRect",blockType:e.COMMAND,text:i({id:"st7789Display.drawRoundRect",default:"draw round rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT] and radius: [R]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},WIDTH:{type:t.NUMBER,defaultValue:100},HEIGHT:{type:t.NUMBER,defaultValue:50},R:{type:t.NUMBER,defaultValue:5}}},{opcode:"fillRoundRect",blockType:e.COMMAND,text:i({id:"st7789Display.fillRoundRect",default:"fill round rectangle at x: [X] y: [Y] of width: [WIDTH] height: [HEIGHT] and radius: [R]"}),arguments:{X:{type:t.NUMBER,defaultValue:0},Y:{type:t.NUMBER,defaultValue:0},WIDTH:{type:t.NUMBER,defaultValue:100},HEIGHT:{type:t.NUMBER,defaultValue:50},R:{type:t.NUMBER,defaultValue:5}}}],menus:{LISTS:{items:"LISTS_MENU"},width:{acceptReporters:!1,items:this.WIDTH_MENU},height:{acceptReporters:!1,items:this.HEIGHT_MENU},backlightState:{acceptReporters:!1,items:this.BACKLIGHT_STATE_MENU},displayRotation:{acceptReporters:!1,items:this.DISPLAY_ROTATION_MENU},displayMode:{acceptReporters:!1,items:this.DISPLAY_MODE_MENU},flip:{acceptReporters:!1,items:this.FLIP_MENU}}}}async getDevice(){if(this.send){const{width:i,height:a,baudrate:s,bus:l,sck:o,mosi:r,dc:u,cs:n,rst:d,bl:p}=this.option;if(-1!==o&&-1!==r&&-1!==u&&-1!==n&&-1!==d){const c=`display_${l}_${o}_`+r;if(this.st7789){if(this.st7789.name===c)return this.st7789;this.st7789=null}else await this.send("const ST7789 = (function (f){return eval(new TextDecoder().decode(require('fs').readFile(f)))})('./st7789.js')",N);await this.send(`const ${c} = new ST7789()`,N);var t=JSON.stringify({baudrate:1e6*s,miso:-1,sck:o,mosi:r}),e=JSON.stringify({rotation:0,width:i,height:a,dc:u,cs:n,rst:d,bl:p});await this.send(c+`.setup(board.spi(${l}, ${t}), ${e})`,N),R(100);const h=this.send.bind(this),y=this.option;return this.st7789={get name(){return c},get gc(){return`${this.name}.getContext('${y.displayMode}')`},on(){if(-1!==p)return h(this.name+".on()",N)},off(){if(-1!==p)return h(this.name+".off()",N)},send(t){return h(this.gc+"."+t,N)},color16(t,e,i){return this.gc+`.color16(${t},${e},${i})`}},await this.st7789.send("clearScreen()"),await this.st7789.on(),this.st7789}}}setSPI(t){this.gpio&&(this.option.bus=f.toNumber(t.BUS),this.option.baudrate=f.toNumber(t.BAUDRATE),this.option.sck=f.toNumber(this.gpio[t.SCK]),this.option.mosi=f.toNumber(this.gpio[t.MOSI]))}setPins(t){this.gpio&&(this.option.dc=f.toNumber(this.gpio[t.DC]),this.option.cs=f.toNumber(this.gpio[t.CS]),this.option.rst=f.toNumber(this.gpio[t.RST]),this.option.bl=f.toNumber(this.gpio[t.BL]))}setResolution(t){this.option.width=f.toNumber(t.WIDTH),this.option.height=f.toNumber(t.HEIGHT)}async setRotation(t){this.option.rotation=f.toNumber(t.ROTATION),(t=await this.getDevice())&&await t.send(`setRotation(${this.option.rotation})`)}async setBacklight(t){var e=await this.getDevice();e&&await e[f.toString(t.STATE)]()}getWidth(){return this.option.width}getHeight(){return this.option.height}setMode(t){this.option.displayMode=f.toString(t.MODE)}async displayBuffer(){var t;this.option.displayMode===p.BUFFER&&(t=await this.getDevice())&&await t.send("display()")}async clearScreen(t){var e=await this.getDevice();e&&await e.send("clearScreen()")}async fillScreen(t){var e,i,a=await this.getDevice();a&&({r:t,g:e,b:i}=f.toRgbColorObject(t.COLOR),t=a.color16(t,e,i),await a.send(`fillScreen(${t})`))}async setPixel(t){var e,i,a,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),{r:t,g:a,b:s}=f.toRgbColorObject(t.COLOR),t=l.color16(t,a,s),await l.send(`setPixel(${e},${i},${t})`))}async setPenColor(t){var e,i,a=await this.getDevice();a&&({r:t,g:e,b:i}=f.toRgbColorObject(t.COLOR),t=a.color16(t,e,i),await a.send(`setColor(${t})`))}async setFillColor(t){var e,i,a=await this.getDevice();a&&({r:t,g:e,b:i}=f.toRgbColorObject(t.COLOR),t=a.color16(t,e,i),await a.send(`setFillColor(${t})`))}async drawLine(t){var e,i,a,s=await this.getDevice();s&&(e=f.toNumber(t.X1),i=f.toNumber(t.Y1),a=f.toNumber(t.X2),t=f.toNumber(t.Y2),await s.send(`drawLine(${e},${i},${a},${t})`))}async drawRect(t){var e,i,a,s=await this.getDevice();s&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),a=f.toNumber(t.WIDTH),t=f.toNumber(t.HEIGHT),await s.send(`drawRect(${e},${i},${a},${t})`))}async fillRect(t){var e,i,a,s=await this.getDevice();s&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),a=f.toNumber(t.WIDTH),t=f.toNumber(t.HEIGHT),await s.send(`fillRect(${e},${i},${a},${t})`))}async drawCircle(t){var e,i,a=await this.getDevice();a&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),t=f.toNumber(t.R),await a.send(`drawCircle(${e},${i},${t})`))}async fillCircle(t){var e,i,a=await this.getDevice();a&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),t=f.toNumber(t.R),await a.send(`fillCircle(${e},${i},${t})`))}async drawRoundRect(t){var e,i,a,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),a=f.toNumber(t.WIDTH),s=f.toNumber(t.HEIGHT),t=f.toNumber(t.R),await l.send(`drawRoundRect(${e},${i},${a},${s},${t})`))}async fillRoundRect(t){var e,i,a,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),a=f.toNumber(t.WIDTH),s=f.toNumber(t.HEIGHT),t=f.toNumber(t.R),await l.send(`fillRoundRect(${e},${i},${a},${s},${t})`))}async initialGallery(c,t){var e=f.toString(c.GALLERY),t=t.target.lookupVariableById(e);const h=[],y=new Map;e=t.value.map(t=>{var[,t]=t.split(",");const p=decodeURIComponent(t);return new Promise(n=>{const d=new Image;d.src=p,d.onload=()=>{var i=new Uint16Array(d.width*d.height),t={width:d.width,height:d.height,bpp:16},e={color:65535},a=(c.COLOR&&(e.transparent=g(...f.toRgbColorList(c.COLOR)),i.fill(e.transparent)),document.createElement("canvas")),s=(a.width=d.width,a.height=d.height,a.getContext("2d"));s.drawImage(d,0,0,d.width,d.width);for(let e=0;e<d.width;e++)for(let t=0;t<d.height;t++){var[l,o,r,u]=s.getImageData(e,t,1,1).data;0!==u&&(i[t*d.width+e]=g(l,o,r))}t.data=A.arrayBufferToBase64(i.buffer),a="bitmap_"+Date.now().toString(36),h.push(`const ${a}=${JSON.stringify({bitmap:t,option:e})};`),y.set(p,a),n()}})}),await Promise.all(e),await this.run(h.join("\n")),this.imageCache=y}async drawImage(t){var e,i,a,s,l=await this.getDevice();l&&(e=f.toNumber(t.X),i=f.toNumber(t.Y),a=f.toString(t.IMAGE),t={scaleX:s=f.toNumber(t.SIZE)/100,scaleY:s,flipX:!!((s=f.toNumber(t.FLIP))&c.TURN_UPSIDE_DOWN),flipY:!!(s&c.SIDE_TO_SIDE)},this.imageCache)&&this.imageCache.has(a)&&(s=this.imageCache.get(a),await l.send(`drawBitmap(${e},${i},${s}.bitmap,Object.assign(${s}.option, ${JSON.stringify(t)}))`))}}),await a.extensions.use("pixelGallery"),a.vm.emit("EXTENSION_SELECTED")}(window.Scratch);