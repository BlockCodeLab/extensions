!async function(){const{motionVector:F,scratchAtan2:N}=await Scratch.require("./math.js"),D=480,t=360;Scratch.export(class{constructor(){this.frameNumber=0,this.lastAnalyzedFrame=0,this.motionAmount=0,this.motionDirection=0,this.curr=null,this.prev=null,this._arrays=new ArrayBuffer(345600),this._curr=new Uint8ClampedArray(this._arrays,0,D*t),this._prev=new Uint8ClampedArray(this._arrays,172800,D*t)}reset(){this.frameNumber=0,this.lastAnalyzedFrame=0,this.motionAmount=this.motionDirection=0,this.prev=this.curr=null}addFrame(t){this.frameNumber++,this.prev=this.curr,this.curr=new Uint32Array(t.buffer.slice(0));t=this._prev;this._prev=this._curr,this._curr=t;for(let t=0;t<this.curr.length;t++)this._curr[t]=255&this.curr[t]}analyzeFrame(){if(this.curr&&this.prev){if(this.lastAnalyzedFrame!==this.frameNumber){this.lastAnalyzedFrame=this.frameNumber;var{_curr:c,_prev:f}=this,A=17;let m=0,u=0,l=0;for(let n=9;n<351;n+=A)for(let h=9;h<471;h+=A){let t=0,r=0,i=0,o=0,e=0,a=(n-8)*D+h-8,s=a+A;for(var v=(n+8)*D+h+8;a<=v;a+=463,s+=D)for(;a<=s;a+=1){var p=f[a]-c[a],y=c[a-1]-c[a+1],_=c[a-D]-c[a+D];t+=y*y,r+=y*_,i+=_*_,e+=y*p,o+=_*p}var{u:d,v:M}=F(t,r,i,e,o);-A<d&&d<A&&-A<M&&M<A&&(m+=d,u+=M,l++)}m/=l,u/=l,this.motionAmount=Math.round(100*Math.hypot(m,u)),10<this.motionAmount&&(this.motionDirection=N(u,m))}}else this.motionAmount=this.motionDirection=-1}getLocalMotion(m,u){if(this.curr&&this.prev){if(u.motionFrameNumber!==this.frameNumber){var{_prev:l,_curr:c}=this,f=(m.updateCPURenderAttributes(),m.getFastBounds()),A=Math.max(Math.floor(f.left+240),1),v=Math.min(Math.floor(f.right+240),479),p=Math.max(Math.floor(180-f.top),1),y=Math.min(Math.floor(180-f.bottom),359);let i=0,o=0,e=0,a=0,s=0,h=0;var _,d,M,b=[0,0,0];for(let r=p;r<y;r++)for(let t=A;t<v;t++)b[0]=t-240,b[1]=180-r,m.isTouching(b)&&(_=l[M=r*D+t]-c[M],d=c[M-1]-c[M+1],M=c[M-D]-c[M+D],i+=d*d,o+=d*M,e+=M*M,s+=d*_,a+=M*_,h++);let{u:t,v:r}=F(i,o,e,s,a),n=0;h&&(n=h,h/=256,t/=h,r/=h),u.motionAmount=Math.round(.02*n*Math.hypot(t,r)),100<u.motionAmount&&(u.motionAmount=100),u.motionAmount>10/3&&(u.motionDirection=N(r,t)),u.motionFrameNumber=this.frameNumber}}else u.motionAmount=u.motionDirection=-1}})}();