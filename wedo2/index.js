!function(){const t=Scratch.ArgumentType,e=Scratch.BlockType,r=Scratch.Cast,i=Scratch.formatMessage,o=Scratch.Color,n=Scratch.BLE,s=Scratch.Base64Util,a=Scratch.MathUtil,l=Scratch.RateLimiter,d=Scratch.log,T={DEVICE_SERVICE:"00001523-1212-efde-1523-785feabcd123",IO_SERVICE:"00004f0e-1212-efde-1523-785feabcd123"},u={ATTACHED_IO:"00001527-1212-efde-1523-785feabcd123",LOW_VOLTAGE_ALERT:"00001528-1212-efde-1523-785feabcd123",INPUT_VALUES:"00001560-1212-efde-1523-785feabcd123",INPUT_COMMAND:"00001563-1212-efde-1523-785feabcd123",OUTPUT_COMMAND:"00001565-1212-efde-1523-785feabcd123"},h=100,c={MOTOR:1,PIEZO:22,LED:23,TILT:34,DISTANCE:35},O={LED:6,PIEZO:5},_={MOTOR_POWER:1,PLAY_TONE:2,STOP_TONE:3,WRITE_RGB:4,SET_VOLUME:255},m={TILT:0,DISTANCE:0,LED:1},p={TILT:0,DISTANCE:1,LED:0};class E{constructor(t,e){this._parent=t,this._index=e,this._direction=1,this._power=100,this._isOn=!1,this._pendingTimeoutId=null,this._pendingTimeoutStartTime=null,this._pendingTimeoutDelay=null,this.startBraking=this.startBraking.bind(this),this.turnOff=this.turnOff.bind(this)}static get BRAKE_TIME_MS(){return 1e3}get direction(){return this._direction}set direction(t){this._direction=t<0?-1:1}get power(){return this._power}set power(t){t=Math.max(0,Math.min(t,100));this._power=0===t?0:30+70/(100/t)}get isOn(){return this._isOn}get pendingTimeoutStartTime(){return this._pendingTimeoutStartTime}get pendingTimeoutDelay(){return this._pendingTimeoutDelay}turnOn(){var t;0!==this._power&&(t=this._parent.generateOutputCommand(this._index+1,_.MOTOR_POWER,[this._power*this._direction]),this._parent.send(u.OUTPUT_COMMAND,t),this._isOn=!0,this._clearTimeout())}turnOnFor(t){0!==this._power&&(t=Math.max(0,t),this.turnOn(),this._setNewTimeout(this.startBraking,t))}startBraking(){var t;0!==this._power&&(t=this._parent.generateOutputCommand(this._index+1,_.MOTOR_POWER,[127]),this._parent.send(u.OUTPUT_COMMAND,t),this._isOn=!1,this._setNewTimeout(this.turnOff,E.BRAKE_TIME_MS))}turnOff(t=!0){var e;0!==this._power&&(e=this._parent.generateOutputCommand(this._index+1,_.MOTOR_POWER,[0]),this._parent.send(u.OUTPUT_COMMAND,e,t),this._isOn=!1)}_clearTimeout(){null!==this._pendingTimeoutId&&(clearTimeout(this._pendingTimeoutId),this._pendingTimeoutId=null,this._pendingTimeoutStartTime=null,this._pendingTimeoutDelay=null)}_setNewTimeout(t,e){this._clearTimeout();const i=setTimeout(()=>{this._pendingTimeoutId===i&&(this._pendingTimeoutId=null,this._pendingTimeoutStartTime=null,this._pendingTimeoutDelay=null),t()},e);this._pendingTimeoutId=i,this._pendingTimeoutStartTime=Date.now(),this._pendingTimeoutDelay=e}}class I{constructor(t,e){this._runtime=t,this._runtime.on("PROJECT_STOP_ALL",this.stopAll.bind(this)),this._extensionId=e,this._ports=["none","none"],this._motors=[null,null],this._sensors={tiltX:0,tiltY:0,distance:0},this._ble=null,this._runtime.registerPeripheralExtension(e,this),this._rateLimiter=new l(20),this._batteryLevelIntervalId=null,this.reset=this.reset.bind(this),this._onConnect=this._onConnect.bind(this),this._onMessage=this._onMessage.bind(this),this._checkBatteryLevel=this._checkBatteryLevel.bind(this)}get tiltX(){return this._sensors.tiltX}get tiltY(){return this._sensors.tiltY}get distance(){return this._sensors.distance}motor(t){return this._motors[t]}stopAllMotors(){this._motors.forEach(t=>{t&&t.turnOff(!1)})}setLED(t){t=[t>>16&255,t>>8&255,255&t],t=this.generateOutputCommand(O.LED,_.WRITE_RGB,t);return this.send(u.OUTPUT_COMMAND,t)}setLEDMode(){var t=this.generateInputCommand(O.LED,c.LED,m.LED,0,p.LED,!1);return this.send(u.INPUT_COMMAND,t)}stopLED(){var t=this.generateOutputCommand(O.LED,_.WRITE_RGB,[0,0,0]);return this.send(u.OUTPUT_COMMAND,t)}playTone(t,e){t=this.generateOutputCommand(O.PIEZO,_.PLAY_TONE,[t,t>>8,e,e>>8]);return this.send(u.OUTPUT_COMMAND,t)}stopTone(){var t=this.generateOutputCommand(O.PIEZO,_.STOP_TONE);return this.send(u.OUTPUT_COMMAND,t,!1)}stopAll(){this.isConnected()&&(this.stopTone(),this.stopAllMotors())}scan(){this._ble&&this._ble.disconnect(),this._ble=new n(this._runtime,this._extensionId,{filters:[{services:[T.DEVICE_SERVICE]}],optionalServices:[T.IO_SERVICE]},this._onConnect,this.reset)}connect(t){this._ble&&this._ble.connectPeripheral(t)}disconnect(){this._ble&&this._ble.disconnect(),this.reset()}reset(){this._ports=["none","none"],this._motors=[null,null],this._sensors={tiltX:0,tiltY:0,distance:0},this._batteryLevelIntervalId&&(window.clearInterval(this._batteryLevelIntervalId),this._batteryLevelIntervalId=null)}isConnected(){let t=!1;return t=this._ble?this._ble.isConnected():t}send(t,e,i=!0){return!this.isConnected()||i&&!this._rateLimiter.okayToSend()?Promise.resolve():this._ble.write(T.IO_SERVICE,t,s.uint8ArrayToBase64(e),"base64")}generateOutputCommand(t,e,i=null){let o=[t,e];return o=i?o.concat(i.length).concat(i):o}generateInputCommand(t,e,i,o,r,n){return[1,2,t,e,i,o,0,0,0,r,n?1:0]}_onConnect(){this.setLEDMode(),this.setLED(255),this._ble.startNotifications(T.DEVICE_SERVICE,u.ATTACHED_IO,this._onMessage),this._batteryLevelIntervalId=window.setInterval(this._checkBatteryLevel,5e3)}_onMessage(t){switch(t[0]){case 1:case 2:var e=t[0];0===t[1]?this._clearPort(e):this._registerSensorOrMotor(e,t[3]);break;default:e=t[1],e=this._ports[e-1];e===c.DISTANCE&&(this._sensors.distance=t[2]),e===c.TILT&&(this._sensors.tiltX=t[2],this._sensors.tiltY=t[3])}}_checkBatteryLevel(){this._ble.read(T.DEVICE_SERVICE,u.LOW_VOLTAGE_ALERT,!1)}_registerSensorOrMotor(t,e){var i;(this._ports[t-1]=e)===c.MOTOR?this._motors[t-1]=new E(this,t-1):(i=e===c.DISTANCE?"DISTANCE":"TILT",t=this.generateInputCommand(t,e,m[i],1,p[i],!0),this.send(u.INPUT_COMMAND,t),this._ble.startNotifications(T.IO_SERVICE,u.INPUT_VALUES,this._onMessage))}_clearPort(t){var e=this._ports[t-1];e===c.TILT&&(this._sensors.tiltX=this._sensors.tiltY=0),e===c.DISTANCE&&(this._sensors.distance=0),this._ports[t-1]="none",this._motors[t-1]=null}}const D={DEFAULT:"motor",A:"motor A",B:"motor B",ALL:"all motors"},R={FORWARD:"this way",BACKWARD:"that way",REVERSE:"reverse"},A={UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right",ANY:"any"};Scratch.extensions.register(new class f{static get EXTENSION_ID(){return"wedo2"}static get TILT_THRESHOLD(){return 15}constructor(){this.runtime=Scratch.vm.runtime,this._peripheral=new I(this.runtime,f.EXTENSION_ID)}getInfo(){return{id:f.EXTENSION_ID,name:"WeDo 2.0",blockIconURI:"data:image/png;base64,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",showStatusButton:!0,blocks:[{opcode:"motorOnFor",text:i({id:"wedo2.motorOnFor",default:"turn [MOTOR_ID] on for [DURATION] seconds",description:"turn a motor on for some time"}),blockType:e.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:D.DEFAULT},DURATION:{type:t.NUMBER,defaultValue:1}}},{opcode:"motorOn",text:i({id:"wedo2.motorOn",default:"turn [MOTOR_ID] on",description:"turn a motor on indefinitely"}),blockType:e.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:D.DEFAULT}}},{opcode:"motorOff",text:i({id:"wedo2.motorOff",default:"turn [MOTOR_ID] off",description:"turn a motor off"}),blockType:e.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:D.DEFAULT}}},{opcode:"startMotorPower",text:i({id:"wedo2.startMotorPower",default:"set [MOTOR_ID] power to [POWER]",description:"set the motor's power and turn it on"}),blockType:e.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:D.DEFAULT},POWER:{type:t.NUMBER,defaultValue:100}}},{opcode:"setMotorDirection",text:i({id:"wedo2.setMotorDirection",default:"set [MOTOR_ID] direction to [MOTOR_DIRECTION]",description:"set the motor's turn direction"}),blockType:e.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:D.DEFAULT},MOTOR_DIRECTION:{type:t.STRING,menu:"MOTOR_DIRECTION",defaultValue:R.FORWARD}}},{opcode:"setLightHue",text:i({id:"wedo2.setLightHue",default:"set light color to [HUE]",description:"set the LED color"}),blockType:e.COMMAND,arguments:{HUE:{type:t.NUMBER,defaultValue:50}}},{opcode:"playNoteFor",text:i({id:"wedo2.playNoteFor",default:"play note [NOTE] for [DURATION] seconds",description:"play a certain note for some time"}),blockType:e.COMMAND,arguments:{NOTE:{type:t.NUMBER,defaultValue:60},DURATION:{type:t.NUMBER,defaultValue:.5}},hideFromPalette:!0},{opcode:"whenDistance",text:i({id:"wedo2.whenDistance",default:"when distance [OP] [REFERENCE]",description:"check for when distance is < or > than reference"}),blockType:e.HAT,arguments:{OP:{type:t.STRING,menu:"OP",defaultValue:"<"},REFERENCE:{type:t.NUMBER,defaultValue:50}}},{opcode:"whenTilted",text:i({id:"wedo2.whenTilted",default:"when tilted [TILT_DIRECTION_ANY]",description:"check when tilted in a certain direction"}),func:"isTilted",blockType:e.HAT,arguments:{TILT_DIRECTION_ANY:{type:t.STRING,menu:"TILT_DIRECTION_ANY",defaultValue:A.ANY}}},{opcode:"getDistance",text:i({id:"wedo2.getDistance",default:"distance",description:"the value returned by the distance sensor"}),blockType:e.REPORTER},{opcode:"isTilted",text:i({id:"wedo2.isTilted",default:"tilted [TILT_DIRECTION_ANY]?",description:"whether the tilt sensor is tilted"}),blockType:e.BOOLEAN,arguments:{TILT_DIRECTION_ANY:{type:t.STRING,menu:"TILT_DIRECTION_ANY",defaultValue:A.ANY}}},{opcode:"getTiltAngle",text:i({id:"wedo2.getTiltAngle",default:"tilt angle [TILT_DIRECTION]",description:"the angle returned by the tilt sensor"}),blockType:e.REPORTER,arguments:{TILT_DIRECTION:{type:t.STRING,menu:"TILT_DIRECTION",defaultValue:A.UP}}}],menus:{MOTOR_ID:{acceptReporters:!0,items:[{text:i({id:"wedo2.motorId.default",default:"motor",description:"label for motor element in motor menu for LEGO WeDo 2 extension"}),value:D.DEFAULT},{text:i({id:"wedo2.motorId.a",default:"motor A",description:"label for motor A element in motor menu for LEGO WeDo 2 extension"}),value:D.A},{text:i({id:"wedo2.motorId.b",default:"motor B",description:"label for motor B element in motor menu for LEGO WeDo 2 extension"}),value:D.B},{text:i({id:"wedo2.motorId.all",default:"all motors",description:"label for all motors element in motor menu for LEGO WeDo 2 extension"}),value:D.ALL}]},MOTOR_DIRECTION:{acceptReporters:!0,items:[{text:i({id:"wedo2.motorDirection.forward",default:"this way",description:"label for forward element in motor direction menu for LEGO WeDo 2 extension"}),value:R.FORWARD},{text:i({id:"wedo2.motorDirection.backward",default:"that way",description:"label for backward element in motor direction menu for LEGO WeDo 2 extension"}),value:R.BACKWARD},{text:i({id:"wedo2.motorDirection.reverse",default:"reverse",description:"label for reverse element in motor direction menu for LEGO WeDo 2 extension"}),value:R.REVERSE}]},TILT_DIRECTION:{acceptReporters:!0,items:[{text:i({id:"wedo2.tiltDirection.up",default:"up",description:"label for up element in tilt direction menu for LEGO WeDo 2 extension"}),value:A.UP},{text:i({id:"wedo2.tiltDirection.down",default:"down",description:"label for down element in tilt direction menu for LEGO WeDo 2 extension"}),value:A.DOWN},{text:i({id:"wedo2.tiltDirection.left",default:"left",description:"label for left element in tilt direction menu for LEGO WeDo 2 extension"}),value:A.LEFT},{text:i({id:"wedo2.tiltDirection.right",default:"right",description:"label for right element in tilt direction menu for LEGO WeDo 2 extension"}),value:A.RIGHT}]},TILT_DIRECTION_ANY:{acceptReporters:!0,items:[{text:i({id:"wedo2.tiltDirection.up",default:"up"}),value:A.UP},{text:i({id:"wedo2.tiltDirection.down",default:"down"}),value:A.DOWN},{text:i({id:"wedo2.tiltDirection.left",default:"left"}),value:A.LEFT},{text:i({id:"wedo2.tiltDirection.right",default:"right"}),value:A.RIGHT},{text:i({id:"wedo2.tiltDirection.any",default:"any",description:"label for any element in tilt direction menu for LEGO WeDo 2 extension"}),value:A.ANY}]},OP:{acceptReporters:!0,items:["<",">"]}}}}motorOnFor(e){let i=1e3*r.toNumber(e.DURATION);return i=a.clamp(i,0,15e3),new Promise(t=>{this._forEachMotor(e.MOTOR_ID,t=>{(t=this._peripheral.motor(t))&&t.turnOnFor(i)}),setTimeout(t,i)})}motorOn(t){return this._forEachMotor(t.MOTOR_ID,t=>{(t=this._peripheral.motor(t))&&t.turnOn()}),new Promise(t=>{window.setTimeout(()=>{t()},h)})}motorOff(t){return this._forEachMotor(t.MOTOR_ID,t=>{(t=this._peripheral.motor(t))&&t.turnOff()}),new Promise(t=>{window.setTimeout(()=>{t()},h)})}startMotorPower(e){return this._forEachMotor(e.MOTOR_ID,t=>{(t=this._peripheral.motor(t))&&(t.power=a.clamp(r.toNumber(e.POWER),0,100),t.turnOn())}),new Promise(t=>{window.setTimeout(()=>{t()},h)})}setMotorDirection(i){return this._forEachMotor(i.MOTOR_ID,t=>{var e=this._peripheral.motor(t);if(e){switch(i.MOTOR_DIRECTION){case R.FORWARD:e.direction=1;break;case R.BACKWARD:e.direction=-1;break;case R.REVERSE:e.direction=-e.direction;break;default:d.warn("Unknown motor direction in setMotorDirection: "+i.DIRECTION)}e.isOn&&(e.pendingTimeoutDelay?e.turnOnFor(e.pendingTimeoutStartTime+e.pendingTimeoutDelay-Date.now()):e.turnOn())}}),new Promise(t=>{window.setTimeout(()=>{t()},h)})}setLightHue(t){return t=r.toNumber(t.HUE),t=360*a.wrapClamp(t,0,100)/100,t=o.hsvToRgb({h:t,s:1,v:1}),t=o.rgbToDecimal(t),this._peripheral.setLED(t),new Promise(t=>{window.setTimeout(()=>{t()},h)})}playNoteFor(t){let i=1e3*r.toNumber(t.DURATION);i=a.clamp(i,0,3e3);const o=a.clamp(r.toNumber(t.NOTE),25,125);if(0!==i)return new Promise(t=>{var e=this._noteToTone(o);this._peripheral.playTone(e,i),setTimeout(t,i)})}whenDistance(t){switch(t.OP){case"<":return this._peripheral.distance<r.toNumber(t.REFERENCE);case">":return this._peripheral.distance>r.toNumber(t.REFERENCE);default:return d.warn("Unknown comparison operator in whenDistance: "+t.OP),!1}}whenTilted(t){return this._isTilted(t.TILT_DIRECTION_ANY)}getDistance(){return this._peripheral.distance}isTilted(t){return this._isTilted(t.TILT_DIRECTION_ANY)}getTiltAngle(t){return this._getTiltAngle(t.TILT_DIRECTION)}_isTilted(t){return t!==A.ANY?this._getTiltAngle(t)>=f.TILT_THRESHOLD:this._getTiltAngle(A.UP)>=f.TILT_THRESHOLD||this._getTiltAngle(A.DOWN)>=f.TILT_THRESHOLD||this._getTiltAngle(A.LEFT)>=f.TILT_THRESHOLD||this._getTiltAngle(A.RIGHT)>=f.TILT_THRESHOLD}_getTiltAngle(t){switch(t){case A.UP:return 45<this._peripheral.tiltY?256-this._peripheral.tiltY:-this._peripheral.tiltY;case A.DOWN:return 45<this._peripheral.tiltY?this._peripheral.tiltY-256:this._peripheral.tiltY;case A.LEFT:return 45<this._peripheral.tiltX?256-this._peripheral.tiltX:-this._peripheral.tiltX;case A.RIGHT:return 45<this._peripheral.tiltX?this._peripheral.tiltX-256:this._peripheral.tiltX;default:d.warn("Unknown tilt direction in _getTiltAngle: "+t)}}_forEachMotor(t,e){let i;switch(t){case D.A:i=[0];break;case D.B:i=[1];break;case D.ALL:case D.DEFAULT:i=[0,1];break;default:d.warn("Invalid motor ID: "+t),i=[]}for(const o of i)e(o)}_noteToTone(t){return 440*Math.pow(2,(t-69)/12)}})}();