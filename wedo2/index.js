!function(e){const t=e.ArgumentType,i=e.BlockType,n=e.Cast,o=e.formatMessage,r=e.Color,s=e.BLE,a=e.Base64Util,l=e.MathUtil,d=e.RateLimiter,T=e.log,u={DEVICE_SERVICE:"00001523-1212-efde-1523-785feabcd123",IO_SERVICE:"00004f0e-1212-efde-1523-785feabcd123"},h={ATTACHED_IO:"00001527-1212-efde-1523-785feabcd123",LOW_VOLTAGE_ALERT:"00001528-1212-efde-1523-785feabcd123",INPUT_VALUES:"00001560-1212-efde-1523-785feabcd123",INPUT_COMMAND:"00001563-1212-efde-1523-785feabcd123",OUTPUT_COMMAND:"00001565-1212-efde-1523-785feabcd123"},c=100,O={MOTOR:1,PIEZO:22,LED:23,TILT:34,DISTANCE:35},_={LED:6,PIEZO:5},m={MOTOR_POWER:1,PLAY_TONE:2,STOP_TONE:3,WRITE_RGB:4,SET_VOLUME:255},p={TILT:0,DISTANCE:0,LED:1},E={TILT:0,DISTANCE:1,LED:0};class I{constructor(e,t){this._parent=e,this._index=t,this._direction=1,this._power=100,this._isOn=!1,this._pendingTimeoutId=null,this._pendingTimeoutStartTime=null,this._pendingTimeoutDelay=null,this.startBraking=this.startBraking.bind(this),this.turnOff=this.turnOff.bind(this)}static get BRAKE_TIME_MS(){return 1e3}get direction(){return this._direction}set direction(e){this._direction=e<0?-1:1}get power(){return this._power}set power(e){e=Math.max(0,Math.min(e,100));this._power=0===e?0:30+70/(100/e)}get isOn(){return this._isOn}get pendingTimeoutStartTime(){return this._pendingTimeoutStartTime}get pendingTimeoutDelay(){return this._pendingTimeoutDelay}turnOn(){var e;0!==this._power&&(e=this._parent.generateOutputCommand(this._index+1,m.MOTOR_POWER,[this._power*this._direction]),this._parent.send(h.OUTPUT_COMMAND,e),this._isOn=!0,this._clearTimeout())}turnOnFor(e){0!==this._power&&(e=Math.max(0,e),this.turnOn(),this._setNewTimeout(this.startBraking,e))}startBraking(){var e;0!==this._power&&(e=this._parent.generateOutputCommand(this._index+1,m.MOTOR_POWER,[127]),this._parent.send(h.OUTPUT_COMMAND,e),this._isOn=!1,this._setNewTimeout(this.turnOff,I.BRAKE_TIME_MS))}turnOff(e=!0){var t;0!==this._power&&(t=this._parent.generateOutputCommand(this._index+1,m.MOTOR_POWER,[0]),this._parent.send(h.OUTPUT_COMMAND,t,e),this._isOn=!1)}_clearTimeout(){null!==this._pendingTimeoutId&&(clearTimeout(this._pendingTimeoutId),this._pendingTimeoutId=null,this._pendingTimeoutStartTime=null,this._pendingTimeoutDelay=null)}_setNewTimeout(e,t){this._clearTimeout();const i=setTimeout(()=>{this._pendingTimeoutId===i&&(this._pendingTimeoutId=null,this._pendingTimeoutStartTime=null,this._pendingTimeoutDelay=null),e()},t);this._pendingTimeoutId=i,this._pendingTimeoutStartTime=Date.now(),this._pendingTimeoutDelay=t}}class D{constructor(e,t){this._runtime=e,this._runtime.on("PROJECT_STOP_ALL",this.stopAll.bind(this)),this._extensionId=t,this._ports=["none","none"],this._motors=[null,null],this._sensors={tiltX:0,tiltY:0,distance:0},this._ble=null,this._runtime.registerPeripheralExtension(t,this),this._rateLimiter=new d(20),this._batteryLevelIntervalId=null,this.reset=this.reset.bind(this),this._onConnect=this._onConnect.bind(this),this._onMessage=this._onMessage.bind(this),this._checkBatteryLevel=this._checkBatteryLevel.bind(this)}get tiltX(){return this._sensors.tiltX}get tiltY(){return this._sensors.tiltY}get distance(){return this._sensors.distance}motor(e){return this._motors[e]}stopAllMotors(){this._motors.forEach(e=>{e&&e.turnOff(!1)})}setLED(e){e=[e>>16&255,e>>8&255,255&e],e=this.generateOutputCommand(_.LED,m.WRITE_RGB,e);return this.send(h.OUTPUT_COMMAND,e)}setLEDMode(){var e=this.generateInputCommand(_.LED,O.LED,p.LED,0,E.LED,!1);return this.send(h.INPUT_COMMAND,e)}stopLED(){var e=this.generateOutputCommand(_.LED,m.WRITE_RGB,[0,0,0]);return this.send(h.OUTPUT_COMMAND,e)}playTone(e,t){e=this.generateOutputCommand(_.PIEZO,m.PLAY_TONE,[e,e>>8,t,t>>8]);return this.send(h.OUTPUT_COMMAND,e)}stopTone(){var e=this.generateOutputCommand(_.PIEZO,m.STOP_TONE);return this.send(h.OUTPUT_COMMAND,e,!1)}stopAll(){this.isConnected()&&(this.stopTone(),this.stopAllMotors())}scan(){this._ble&&this._ble.disconnect(),this._ble=new s(this._runtime,this._extensionId,{filters:[{services:[u.DEVICE_SERVICE]}],optionalServices:[u.IO_SERVICE]},this._onConnect,this.reset)}connect(e){this._ble&&this._ble.connectPeripheral(e)}disconnect(){this._ble&&this._ble.disconnect(),this.reset()}reset(){this._ports=["none","none"],this._motors=[null,null],this._sensors={tiltX:0,tiltY:0,distance:0},this._batteryLevelIntervalId&&(window.clearInterval(this._batteryLevelIntervalId),this._batteryLevelIntervalId=null)}isConnected(){let e=!1;return e=this._ble?this._ble.isConnected():e}send(e,t,i=!0){return!this.isConnected()||i&&!this._rateLimiter.okayToSend()?Promise.resolve():this._ble.write(u.IO_SERVICE,e,a.uint8ArrayToBase64(t),"base64")}generateOutputCommand(e,t,i=null){let o=[e,t];return o=i?o.concat(i.length).concat(i):o}generateInputCommand(e,t,i,o,n,r){return[1,2,e,t,i,o,0,0,0,n,r?1:0]}_onConnect(){this.setLEDMode(),this.setLED(255),this._ble.startNotifications(u.DEVICE_SERVICE,h.ATTACHED_IO,this._onMessage),this._batteryLevelIntervalId=window.setInterval(this._checkBatteryLevel,5e3)}_onMessage(e){switch(e[0]){case 1:case 2:var t=e[0];0===e[1]?this._clearPort(t):this._registerSensorOrMotor(t,e[3]);break;default:t=e[1],t=this._ports[t-1];t===O.DISTANCE&&(this._sensors.distance=e[2]),t===O.TILT&&(this._sensors.tiltX=e[2],this._sensors.tiltY=e[3])}}_checkBatteryLevel(){this._ble.read(u.DEVICE_SERVICE,h.LOW_VOLTAGE_ALERT,!1)}_registerSensorOrMotor(e,t){var i;(this._ports[e-1]=t)===O.MOTOR?this._motors[e-1]=new I(this,e-1):(i=t===O.DISTANCE?"DISTANCE":"TILT",e=this.generateInputCommand(e,t,p[i],1,E[i],!0),this.send(h.INPUT_COMMAND,e),this._ble.startNotifications(u.IO_SERVICE,h.INPUT_VALUES,this._onMessage))}_clearPort(e){var t=this._ports[e-1];t===O.TILT&&(this._sensors.tiltX=this._sensors.tiltY=0),t===O.DISTANCE&&(this._sensors.distance=0),this._ports[e-1]="none",this._motors[e-1]=null}}const R={DEFAULT:"motor",A:"motor A",B:"motor B",ALL:"all motors"},A={FORWARD:"this way",BACKWARD:"that way",REVERSE:"reverse"},f={UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right",ANY:"any"};e.extensions.register(new class g{static get EXTENSION_ID(){return"wedo2"}static get TILT_THRESHOLD(){return 15}constructor(){this.runtime=e.vm.runtime,this._peripheral=new D(this.runtime,g.EXTENSION_ID)}getInfo(){return{id:g.EXTENSION_ID,name:"WeDo 2.0",blockIconURI:"data:image/png;base64,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",showStatusButton:!0,blocks:[{opcode:"motorOnFor",text:o({id:"wedo2.motorOnFor",default:"turn [MOTOR_ID] on for [DURATION] seconds",description:"turn a motor on for some time"}),blockType:i.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:R.DEFAULT},DURATION:{type:t.NUMBER,defaultValue:1}}},{opcode:"motorOn",text:o({id:"wedo2.motorOn",default:"turn [MOTOR_ID] on",description:"turn a motor on indefinitely"}),blockType:i.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:R.DEFAULT}}},{opcode:"motorOff",text:o({id:"wedo2.motorOff",default:"turn [MOTOR_ID] off",description:"turn a motor off"}),blockType:i.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:R.DEFAULT}}},{opcode:"startMotorPower",text:o({id:"wedo2.startMotorPower",default:"set [MOTOR_ID] power to [POWER]",description:"set the motor's power and turn it on"}),blockType:i.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:R.DEFAULT},POWER:{type:t.NUMBER,defaultValue:100}}},{opcode:"setMotorDirection",text:o({id:"wedo2.setMotorDirection",default:"set [MOTOR_ID] direction to [MOTOR_DIRECTION]",description:"set the motor's turn direction"}),blockType:i.COMMAND,arguments:{MOTOR_ID:{type:t.STRING,menu:"MOTOR_ID",defaultValue:R.DEFAULT},MOTOR_DIRECTION:{type:t.STRING,menu:"MOTOR_DIRECTION",defaultValue:A.FORWARD}}},{opcode:"setLightHue",text:o({id:"wedo2.setLightHue",default:"set light color to [HUE]",description:"set the LED color"}),blockType:i.COMMAND,arguments:{HUE:{type:t.NUMBER,defaultValue:50}}},{opcode:"playNoteFor",text:o({id:"wedo2.playNoteFor",default:"play note [NOTE] for [DURATION] seconds",description:"play a certain note for some time"}),blockType:i.COMMAND,arguments:{NOTE:{type:t.NUMBER,defaultValue:60},DURATION:{type:t.NUMBER,defaultValue:.5}},hideFromPalette:!0},{opcode:"whenDistance",text:o({id:"wedo2.whenDistance",default:"when distance [OP] [REFERENCE]",description:"check for when distance is < or > than reference"}),blockType:i.HAT,arguments:{OP:{type:t.STRING,menu:"OP",defaultValue:"<"},REFERENCE:{type:t.NUMBER,defaultValue:50}}},{opcode:"whenTilted",text:o({id:"wedo2.whenTilted",default:"when tilted [TILT_DIRECTION_ANY]",description:"check when tilted in a certain direction"}),func:"isTilted",blockType:i.HAT,arguments:{TILT_DIRECTION_ANY:{type:t.STRING,menu:"TILT_DIRECTION_ANY",defaultValue:f.ANY}}},{opcode:"getDistance",text:o({id:"wedo2.getDistance",default:"distance",description:"the value returned by the distance sensor"}),blockType:i.REPORTER},{opcode:"isTilted",text:o({id:"wedo2.isTilted",default:"tilted [TILT_DIRECTION_ANY]?",description:"whether the tilt sensor is tilted"}),blockType:i.BOOLEAN,arguments:{TILT_DIRECTION_ANY:{type:t.STRING,menu:"TILT_DIRECTION_ANY",defaultValue:f.ANY}}},{opcode:"getTiltAngle",text:o({id:"wedo2.getTiltAngle",default:"tilt angle [TILT_DIRECTION]",description:"the angle returned by the tilt sensor"}),blockType:i.REPORTER,arguments:{TILT_DIRECTION:{type:t.STRING,menu:"TILT_DIRECTION",defaultValue:f.UP}}}],menus:{MOTOR_ID:{acceptReporters:!0,items:[{text:o({id:"wedo2.motorId.default",default:"motor",description:"label for motor element in motor menu for LEGO WeDo 2 extension"}),value:R.DEFAULT},{text:o({id:"wedo2.motorId.a",default:"motor A",description:"label for motor A element in motor menu for LEGO WeDo 2 extension"}),value:R.A},{text:o({id:"wedo2.motorId.b",default:"motor B",description:"label for motor B element in motor menu for LEGO WeDo 2 extension"}),value:R.B},{text:o({id:"wedo2.motorId.all",default:"all motors",description:"label for all motors element in motor menu for LEGO WeDo 2 extension"}),value:R.ALL}]},MOTOR_DIRECTION:{acceptReporters:!0,items:[{text:o({id:"wedo2.motorDirection.forward",default:"this way",description:"label for forward element in motor direction menu for LEGO WeDo 2 extension"}),value:A.FORWARD},{text:o({id:"wedo2.motorDirection.backward",default:"that way",description:"label for backward element in motor direction menu for LEGO WeDo 2 extension"}),value:A.BACKWARD},{text:o({id:"wedo2.motorDirection.reverse",default:"reverse",description:"label for reverse element in motor direction menu for LEGO WeDo 2 extension"}),value:A.REVERSE}]},TILT_DIRECTION:{acceptReporters:!0,items:[{text:o({id:"wedo2.tiltDirection.up",default:"up",description:"label for up element in tilt direction menu for LEGO WeDo 2 extension"}),value:f.UP},{text:o({id:"wedo2.tiltDirection.down",default:"down",description:"label for down element in tilt direction menu for LEGO WeDo 2 extension"}),value:f.DOWN},{text:o({id:"wedo2.tiltDirection.left",default:"left",description:"label for left element in tilt direction menu for LEGO WeDo 2 extension"}),value:f.LEFT},{text:o({id:"wedo2.tiltDirection.right",default:"right",description:"label for right element in tilt direction menu for LEGO WeDo 2 extension"}),value:f.RIGHT}]},TILT_DIRECTION_ANY:{acceptReporters:!0,items:[{text:o({id:"wedo2.tiltDirection.up",default:"up"}),value:f.UP},{text:o({id:"wedo2.tiltDirection.down",default:"down"}),value:f.DOWN},{text:o({id:"wedo2.tiltDirection.left",default:"left"}),value:f.LEFT},{text:o({id:"wedo2.tiltDirection.right",default:"right"}),value:f.RIGHT},{text:o({id:"wedo2.tiltDirection.any",default:"any",description:"label for any element in tilt direction menu for LEGO WeDo 2 extension"}),value:f.ANY}]},OP:{acceptReporters:!0,items:["<",">"]}}}}motorOnFor(t){let i=1e3*n.toNumber(t.DURATION);return i=l.clamp(i,0,15e3),new Promise(e=>{this._forEachMotor(t.MOTOR_ID,e=>{(e=this._peripheral.motor(e))&&e.turnOnFor(i)}),setTimeout(e,i)})}motorOn(e){return this._forEachMotor(e.MOTOR_ID,e=>{(e=this._peripheral.motor(e))&&e.turnOn()}),new Promise(e=>{window.setTimeout(()=>{e()},c)})}motorOff(e){return this._forEachMotor(e.MOTOR_ID,e=>{(e=this._peripheral.motor(e))&&e.turnOff()}),new Promise(e=>{window.setTimeout(()=>{e()},c)})}startMotorPower(t){return this._forEachMotor(t.MOTOR_ID,e=>{(e=this._peripheral.motor(e))&&(e.power=l.clamp(n.toNumber(t.POWER),0,100),e.turnOn())}),new Promise(e=>{window.setTimeout(()=>{e()},c)})}setMotorDirection(i){return this._forEachMotor(i.MOTOR_ID,e=>{var t=this._peripheral.motor(e);if(t){switch(i.MOTOR_DIRECTION){case A.FORWARD:t.direction=1;break;case A.BACKWARD:t.direction=-1;break;case A.REVERSE:t.direction=-t.direction;break;default:T.warn("Unknown motor direction in setMotorDirection: "+i.DIRECTION)}t.isOn&&(t.pendingTimeoutDelay?t.turnOnFor(t.pendingTimeoutStartTime+t.pendingTimeoutDelay-Date.now()):t.turnOn())}}),new Promise(e=>{window.setTimeout(()=>{e()},c)})}setLightHue(e){return e=n.toNumber(e.HUE),e=360*l.wrapClamp(e,0,100)/100,e=r.hsvToRgb({h:e,s:1,v:1}),e=r.rgbToDecimal(e),this._peripheral.setLED(e),new Promise(e=>{window.setTimeout(()=>{e()},c)})}playNoteFor(e){let i=1e3*n.toNumber(e.DURATION);i=l.clamp(i,0,3e3);const o=l.clamp(n.toNumber(e.NOTE),25,125);if(0!==i)return new Promise(e=>{var t=this._noteToTone(o);this._peripheral.playTone(t,i),setTimeout(e,i)})}whenDistance(e){switch(e.OP){case"<":return this._peripheral.distance<n.toNumber(e.REFERENCE);case">":return this._peripheral.distance>n.toNumber(e.REFERENCE);default:return T.warn("Unknown comparison operator in whenDistance: "+e.OP),!1}}whenTilted(e){return this._isTilted(e.TILT_DIRECTION_ANY)}getDistance(){return this._peripheral.distance}isTilted(e){return this._isTilted(e.TILT_DIRECTION_ANY)}getTiltAngle(e){return this._getTiltAngle(e.TILT_DIRECTION)}_isTilted(e){return e!==f.ANY?this._getTiltAngle(e)>=g.TILT_THRESHOLD:this._getTiltAngle(f.UP)>=g.TILT_THRESHOLD||this._getTiltAngle(f.DOWN)>=g.TILT_THRESHOLD||this._getTiltAngle(f.LEFT)>=g.TILT_THRESHOLD||this._getTiltAngle(f.RIGHT)>=g.TILT_THRESHOLD}_getTiltAngle(e){switch(e){case f.UP:return 45<this._peripheral.tiltY?256-this._peripheral.tiltY:-this._peripheral.tiltY;case f.DOWN:return 45<this._peripheral.tiltY?this._peripheral.tiltY-256:this._peripheral.tiltY;case f.LEFT:return 45<this._peripheral.tiltX?256-this._peripheral.tiltX:-this._peripheral.tiltX;case f.RIGHT:return 45<this._peripheral.tiltX?this._peripheral.tiltX-256:this._peripheral.tiltX;default:T.warn("Unknown tilt direction in _getTiltAngle: "+e)}}_forEachMotor(e,t){let i;switch(e){case R.A:i=[0];break;case R.B:i=[1];break;case R.ALL:case R.DEFAULT:i=[0,1];break;default:T.warn("Invalid motor ID: "+e),i=[]}for(const o of i)t(o)}_noteToTone(e){return 440*Math.pow(2,(e-69)/12)}})}(window.Scratch);